rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return request.auth.token.role;
    }
    
    function getUserSchoolId() {
      return request.auth.token.schoolId;
    }
    
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    function isStaff() {
      return getUserRole() == 'staff';
    }
    
    function isStudent() {
      return getUserRole() == 'student';
    }
    
    function isParent() {
      return getUserRole() == 'parent';
    }
    
    function isBursar() {
      return getUserRole() == 'bursar';
    }
    
    function belongsToSchool(schoolId) {
      return getUserSchoolId() == schoolId;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ============================================
    // SCHOOLS COLLECTION
    // ============================================
    
    match /schools/{schoolId} {
      // Anyone can create a new school (for registration)
      allow create: if isAuthenticated();
      
      // Only school admin can read their school
      allow read: if isAuthenticated() && belongsToSchool(schoolId);
      
      // Only school admin can update their school
      allow update: if isAuthenticated() && belongsToSchool(schoolId) && isAdmin();
      
      // Never allow school deletion
      allow delete: if false;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
      // Users can read:
      // 1. Their own profile
      // 2. Admins can read all users in their school
      // 3. Staff can read students in their school
      // 4. Parents can read their children (enforced in app)
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        (belongsToSchool(resource.data.schoolId) && isAdmin()) ||
        (belongsToSchool(resource.data.schoolId) && isStaff() && resource.data.role == 'student') ||
        (belongsToSchool(resource.data.schoolId) && isParent())
      );
      
      // Only admins can create users in their school
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      
      // Users can update their own profile, admins can update all
      allow update: if isAuthenticated() && (
        isOwner(userId) ||
        (isAdmin() && belongsToSchool(resource.data.schoolId))
      );
      
      // Only admins can delete users
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // CLASSES COLLECTION
    // ============================================
    
    match /classes/{classId} {
      // Anyone in the school can read classes
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can create/update/delete classes
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // SUBJECTS COLLECTION
    // ============================================
    
    match /subjects/{subjectId} {
      // Anyone in the school can read subjects
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can create/update/delete subjects
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // STAFF ASSIGNMENTS COLLECTION
    // ============================================
    
    match /staff_assignments/{assignmentId} {
      // Anyone in the school can read assignments
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can manage assignments
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // STUDENT CLASSES (ENROLLMENTS) COLLECTION
    // ============================================
    
    match /student_classes/{enrollmentId} {
      // Anyone in the school can read enrollments
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can manage enrollments
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    
    match /attendance/{attendanceId} {
      // Can read if:
      // 1. Admin in the school
      // 2. Staff in the school
      // 3. Student viewing their own attendance
      // 4. Parent (filtered by child in app)
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId) && (
        isAdmin() ||
        isStaff() ||
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        isParent()
      );
      
      // Only admins and staff can create/update attendance
      allow create: if isAuthenticated() && 
        belongsToSchool(request.resource.data.schoolId) && 
        (isAdmin() || isStaff());
      
      allow update: if isAuthenticated() && 
        belongsToSchool(resource.data.schoolId) && 
        (isAdmin() || isStaff());
      
      // Only admins can delete attendance records
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // RESULTS COLLECTION
    // ============================================
    
    match /results/{resultId} {
      // Can read if:
      // 1. Admin in the school
      // 2. Staff in the school
      // 3. Student viewing their own results
      // 4. Parent (filtered by child in app)
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId) && (
        isAdmin() ||
        isStaff() ||
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        isParent()
      );
      
      // Only admins and staff can create/update results
      allow create: if isAuthenticated() && 
        belongsToSchool(request.resource.data.schoolId) && 
        (isAdmin() || isStaff());
      
      allow update: if isAuthenticated() && 
        belongsToSchool(resource.data.schoolId) && 
        (isAdmin() || isStaff());
      
      // Only admins can delete results
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // TERMS COLLECTION
    // ============================================
    
    match /terms/{termId} {
      // Anyone in the school can read terms
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can manage terms
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // PARENT-STUDENT LINKS COLLECTION
    // ============================================
    
    match /parent_student_links/{linkId} {
      // Anyone in the school can read links
      allow read: if isAuthenticated() && belongsToSchool(resource.data.schoolId);
      
      // Only admins can manage parent-student links
      allow create: if isAuthenticated() && isAdmin() && 
        belongsToSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // FINANCIAL TRANSACTIONS COLLECTION
    // ============================================
    
    match /financial_transactions/{transactionId} {
      // Only admins and bursars can read financial data
      allow read: if isAuthenticated() && 
        belongsToSchool(resource.data.schoolId) && 
        (isAdmin() || isBursar());
      
      // Only admins and bursars can create transactions
      allow create: if isAuthenticated() && 
        belongsToSchool(request.resource.data.schoolId) && 
        (isAdmin() || isBursar());
      
      // Only admins can update/delete transactions
      allow update: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      allow delete: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
    }
    
    // ============================================
    // NOTES COLLECTION (LESSON PLANS)
    // ============================================
    
    match /notes/{noteId} {
      // Teachers can read/write their own notes
      // Admins can read all notes in their school
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        (isAdmin() && belongsToSchool(resource.data.schoolId))
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (isAdmin() && belongsToSchool(resource.data.schoolId))
      );
    }

    // ============================================
    // EXAMS COLLECTION
    // ============================================
    
    match /exams/{examId} {
      // Teachers can read/write their own exams
      // Admins can read all exams in their school
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        (isAdmin() && belongsToSchool(resource.data.schoolId))
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (isAdmin() && belongsToSchool(resource.data.schoolId))
      );
    }
    
    // ============================================
    // AUDIT LOGS COLLECTION (IMMUTABLE)
    // ============================================
    
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAuthenticated() && isAdmin() && 
        belongsToSchool(resource.data.schoolId);
      
      // Anyone authenticated can create audit logs
      allow create: if isAuthenticated() && 
        belongsToSchool(request.resource.data.schoolId);
      
      // Audit logs are immutable - no updates or deletes
      allow update: if false;
      allow delete: if false;
    }
  }
}
